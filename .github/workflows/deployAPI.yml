name: Deploy to Self-Hosted Server

on:
    push:
        branches: ["main", "dev", "Github-Actions"]

jobs:
    deploy:
        runs-on: self-hosted

        steps:
            - name: Checkout repository
              uses: actions/checkout@v4
              with:
                  ref: dev

            - name: Stop Flask Server
              run: |
                sudo systemctl stop api.service || true

            - name: Build and Deploy
              run: |
                cd ~/project-copilot-clone-2/server
                source .venv/bin/activate
                pip install -r requirements.txt
  
            - name: Start Flask service
              run: |
                sudo systemctl start api.service

            - name: Stop website service
              run: |
                sudo systemctl stop website.service
            
            - name: Build and deploy
              run: |
                cd ~/project-copilot-clone-2/website
                npm install

            - name: Start website service
              run: |
                sudo systemctl start website.service